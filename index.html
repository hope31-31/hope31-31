<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, query, onSnapshot, doc, setDoc, getDoc, deleteDoc, getDocs, where } 
  from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

console.log("Starting Educational Chat...");

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyD9GQMi0v4ItnkJ2uqKtUUQU59DorLrCAg",
  authDomain: "live-chat-3d2c3.firebaseapp.com",
  projectId: "live-chat-3d2c3",
  storageBucket: "live-chat-3d2c3.firebasestorage.app",
  messagingSenderId: "550798266942",
  appId: "1:550798266942:web:2ce678f70e4f64d6f7376f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();

let username = "";
let currentRoom = "General";
let roomCreators = {};      // Track creators for delete
let unsubscribeMessages = null;
let createdRoomsThisSession = [];

// DOM elements
const chatDiv = document.getElementById("chat");
const roomsDiv = document.getElementById("rooms");
const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const clearBtn = document.getElementById("clearBtn");
const createRoomBtn = document.getElementById("createRoomBtn");
const deleteRoomBtn = document.getElementById("deleteRoomBtn");
const newRoomName = document.getElementById("newRoomName");
const newRoomPass = document.getElementById("newRoomPass");

// --- Authenticate ---
signInAnonymously(auth).then(userCred=>{
  username = userCred.user.uid;
  console.log("Signed in:", username);
  initApp();
}).catch(err=>console.error("Auth error:", err));

// --- Initialize app ---
async function initApp() {
  await ensureGeneral();
  loadRooms();
  joinRoom("General");
}

// --- Ensure General exists ---
async function ensureGeneral() {
  const generalDoc = doc(db,"rooms","General");
  const d = await getDoc(generalDoc);
  if(!d.exists) await setDoc(generalDoc,{name:"General",password:"",creator:"system"});
}

// --- Load rooms ---
function loadRooms() {
  onSnapshot(collection(db,"rooms"), snap=>{
    roomsDiv.innerHTML="";
    snap.forEach(d=>{
      const r = d.data();
      roomCreators[r.name] = r.creator;
      const div = document.createElement("div");
      div.className="room "+(r.name===currentRoom?"selected":"");
      div.textContent=r.name;
      div.onclick = ()=> joinRoom(r.name,r.password);
      roomsDiv.appendChild(div);
    });
  });
}

// --- Join room ---
function joinRoom(name,pass="") {
  if(pass){
    const entered = prompt("Enter password for "+name);
    if(entered!==pass) return alert("Wrong password");
  }
  currentRoom = name;
  listenMessages();
}

// --- Listen to messages ---
function listenMessages() {
  if(unsubscribeMessages) unsubscribeMessages();
  chatDiv.innerHTML="";
  
  const q = query(collection(db,"messages"), where("room","==",currentRoom));
  
  unsubscribeMessages = onSnapshot(q, snap=>{
    chatDiv.innerHTML="";
    snap.forEach(docSnap=>{
      const m = docSnap.data();
      const div = document.createElement("div");
      div.className = "message "+(m.sender===username?"mine":"other");
      div.innerHTML = `<div class="sender">${m.sender}</div>${m.text}`;
      chatDiv.appendChild(div);
    });
    chatDiv.scrollTop = chatDiv.scrollHeight;
  });
}

// --- Send message ---
sendBtn.onclick = async ()=>{
  const text = messageInput.value.trim();
  if(!text) return;
  await addDoc(collection(db,"messages"),{
    text,
    sender:username,
    room:currentRoom,
    createdAt:serverTimestamp()
  });
  messageInput.value="";
};
messageInput.addEventListener("keypress", e=>{if(e.key==="Enter") sendBtn.onclick();});

// --- Clear chat permanently ---
clearBtn.onclick = async ()=>{
  if(!confirm("Clear chat forever?")) return;
  const snap = await getDocs(query(collection(db,"messages"), where("room","==",currentRoom)));
  for(const d of snap.docs) await deleteDoc(d.ref);
};

// --- Create room ---
createRoomBtn.onclick = async ()=>{
  const name = newRoomName.value.trim();
  const pass = newRoomPass.value.trim();
  if(!name) return;
  await setDoc(doc(db,"rooms",name),{name,password:pass,creator:username});
  createdRoomsThisSession.push(name);
  newRoomName.value=""; newRoomPass.value="";
  joinRoom(name,pass);
};

// --- Delete room (only creator) ---
deleteRoomBtn.onclick = async ()=>{
  if(currentRoom==="General") return alert("Cannot delete General");
  if(roomCreators[currentRoom]!==username) return alert("Only the creator can delete this room");
  if(!confirm(`Delete room "${currentRoom}" and all its messages?`)) return;

  await deleteDoc(doc(db,"rooms",currentRoom));
  const snap = await getDocs(query(collection(db,"messages"), where("room","==",currentRoom)));
  for(const d of snap.docs) await deleteDoc(d.ref);
  joinRoom("General");
};

// --- Auto-delete created rooms on tab close ---
window.addEventListener("beforeunload", async ()=>{
  for(const room of createdRoomsThisSession){
    const snap = await getDocs(query(collection(db,"messages"), where("room","==",room)));
    for(const d of snap.docs) await deleteDoc(d.ref);
    await deleteDoc(doc(db,"rooms",room));
  }
});
</script>