<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Educational Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<style>
body {
  margin:0;
  font-family: 'Poppins', Arial, sans-serif;
  background: linear-gradient(135deg,#1e1e2f,#2c2c54);
  color:white;
  display:flex;
  flex-direction:column;
  height:100vh;
}
header {
  padding:15px;
  text-align:center;
  font-size:18px;
  font-weight:600;
  background:rgba(0,0,0,0.3);
}
#rooms {
  display:flex;
  gap:5px;
  padding:5px 10px;
  overflow-x:auto;
  background:rgba(0,0,0,0.2);
}
.room {
  padding:5px 10px;
  background:#6366f1;
  border-radius:12px;
  cursor:pointer;
  white-space:nowrap;
  font-weight:500;
  position: relative;
}
.room.selected { background:#4f46e5; }
#chat {
  flex:1;
  overflow-y:auto;
  padding:10px;
}
.message {
  max-width:70%;
  margin:5px;
  padding:10px;
  border-radius:15px;
  word-wrap: break-word;
}
.sender { font-size:12px; opacity:0.7; margin-bottom:2px; }
.mine { background:#4f46e5; align-self:flex-end; }
.other { background:#2d2d44; align-self:flex-start; }
#inputArea {
  display:flex;
  gap:5px;
  padding:10px;
  width:100%;
  background:rgba(0,0,0,0.3);
}
#messageInput { flex:1; padding:10px; border-radius:15px; border:none; outline:none; }
button {
  padding:10px 15px;
  border:none;
  border-radius:12px;
  background:#6366f1;
  color:white;
  cursor:pointer;
  font-weight:500;
}
#createRoomArea { display:flex; gap:5px; padding:10px; background:rgba(0,0,0,0.2); }
#createRoomArea input { padding:5px; border-radius:12px; border:none; outline:none; }
#deleteRoomBtn { margin-left:10px; background:#f87171; }
</style>
</head>
<body>

<header>Educational Chat</header>

<div id="rooms"></div>

<div id="chat"></div>

<div id="createRoomArea">
  <input id="newRoomName" placeholder="Room name" />
  <input id="newRoomPass" placeholder="Password (optional)" />
  <button id="createRoomBtn">Create Room</button>
  <button id="deleteRoomBtn">Delete Room</button>
</div>

<div id="inputArea">
  <input id="messageInput" placeholder="Type a message..." />
  <button id="sendBtn">Send</button>
  <button id="clearBtn">Clear Chat</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, doc, getDoc, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyD9GQMi0v4ItnkJ2uqKtUUQU59DorLrCAg",
  authDomain: "live-chat-3d2c3.firebaseapp.com",
  projectId: "live-chat-3d2c3",
  storageBucket: "live-chat-3d2c3.firebasestorage.app",
  messagingSenderId: "550798266942",
  appId: "1:550798266942:web:2ce678f70e4f64d6f7376f",
  measurementId: "G-L0K72L8894"
};

// Init Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();
await signInAnonymously(auth);

const username = "Educational Website";

const chatDiv = document.getElementById("chat");
const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const clearBtn = document.getElementById("clearBtn");
const roomsDiv = document.getElementById("rooms");
const newRoomName = document.getElementById("newRoomName");
const newRoomPass = document.getElementById("newRoomPass");
const createRoomBtn = document.getElementById("createRoomBtn");
const deleteRoomBtn = document.getElementById("deleteRoomBtn");

let currentRoom = "General";
const roomsRef = collection(db,"rooms");
const messagesRef = collection(db,"messages");
const deleteRequestsRef = collection(db,"deleteRequests");

// --- Ensure General exists ---
const generalRoomDoc = doc(db,"rooms","General");
getDoc(generalRoomDoc).then(d=>{
  if(!d.exists) setDoc(generalRoomDoc,{name:"General",password:"", temporary:false});
  loadRooms();
});

// --- Load Rooms ---
function loadRooms(){
  onSnapshot(roomsRef,snap=>{
    roomsDiv.innerHTML="";
    snap.forEach(d=>{
      const r = d.data();
      const div = document.createElement("div");
      div.className="room "+(r.name===currentRoom?"selected":"");
      div.textContent=r.name;
      div.onclick=()=>joinRoom(r.name,r.password);
      roomsDiv.appendChild(div);
    });
  });
}

// --- Join Room ---
function joinRoom(name,pass){
  if(pass && pass!==""){
    const entered = prompt("Enter password for "+name);
    if(entered!==pass) return alert("Wrong password");
  }
  currentRoom = name;
  listenMessages();
}

// --- Listen Messages ---
let unsubscribe = null;
function listenMessages(){
  if(unsubscribe) unsubscribe();
  chatDiv.innerHTML="";
  const q = query(messagesRef, orderBy("createdAt"));
  unsubscribe = onSnapshot(q,snap=>{
    chatDiv.innerHTML="";
    snap.forEach(docSnap=>{
      const m = docSnap.data();
      if(m.room===currentRoom){
        const div = document.createElement("div");
        div.className="message "+(m.sender===username?"mine":"other");
        div.innerHTML=`<div class="sender">${m.sender}</div>${m.text}`;
        chatDiv.appendChild(div);
      }
    });
    chatDiv.scrollTop = chatDiv.scrollHeight;
  });
}
joinRoom("General","");

// --- Send Message ---
async function sendMessage(){
  const text = messageInput.value.trim();
  if(!text) return;
  await addDoc(messagesRef,{text,sender:username,room:currentRoom,createdAt:serverTimestamp()});
  messageInput.value="";
}
sendBtn.addEventListener("click",sendMessage);
messageInput.addEventListener("keypress", e=>{if(e.key==="Enter") sendMessage();});

// --- Clear chat locally ---
clearBtn.addEventListener("click", ()=>chatDiv.innerHTML="");

// --- Create Room ---
createRoomBtn.addEventListener("click", async ()=>{
  const name = newRoomName.value.trim();
  const pass = newRoomPass.value.trim();
  if(!name) return;
  await setDoc(doc(db,"rooms",name),{name,password:pass,temporary:false});
  newRoomName.value=""; newRoomPass.value="";
  joinRoom(name,pass);
});

// --- Delete Room Request ---
deleteRoomBtn.addEventListener("click", async ()=>{
  if(currentRoom==="General") return alert("Cannot delete General room");
  const reqDoc = doc(db,"deleteRequests",currentRoom);
  await setDoc(reqDoc,{requester:username,agreed:[],disagreed:[],timestamp:serverTimestamp()});
});

// --- Listen for Delete Requests ---
onSnapshot(deleteRequestsRef, async snap=>{
  snap.docs.forEach(async d=>{
    const req = d.data();
    const roomName = d.id;
    if(roomName!==currentRoom) return;
    if(req.requester===username) return; // don't prompt self
    const agree = confirm(`${req.requester} wants to delete "${roomName}". Agree?`);
    const docRef = doc(db,"deleteRequests",roomName);
    if(agree){
      await updateDoc(docRef,{agreed:arrayUnion(username)});
    } else {
      await updateDoc(docRef,{disagreed:arrayUnion(username)});
    }
  });
});

// --- Monitor Requests and Delete Room if Everyone Agrees ---
onSnapshot(deleteRequestsRef, async snap=>{
  snap.docs.forEach(async d=>{
    const req = d.data();
    const roomName = d.id;
    const roomDoc = await getDoc(doc(db,"rooms",roomName));
    if(!roomDoc.exists()) return;
    // Get all users (naive: messages senders in that room)
    const messagesSnap = await query(messagesRef, orderBy("createdAt"));
    const qSnap = await onSnapshot(messagesRef, ()=>{}); // optional: can track online users better
    // For simplicity, if anyone disagreed, cancel
    if(req.disagreed.length>0) return;
    // If agreed has >=1 (other person), delete
    if(req.agreed.length>=1){
      await db.collection("rooms").doc(roomName).delete();
      const msgsSnap = await db.collection("messages").where("room","==",roomName).get();
      msgsSnap.forEach(m=>m.ref.delete());
      if(currentRoom===roomName) joinRoom("General","");
      await db.collection("deleteRequests").doc(roomName).delete();
    }
  });
});
</script>

</body>
</html>