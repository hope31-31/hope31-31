<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getFirestore, collection, addDoc, serverTimestamp, query, orderBy, 
  onSnapshot, doc, getDoc, setDoc, deleteDoc, getDocs, where 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

// Firebase config
const firebaseConfig = {
  apiKey: "YOUR_KEY",
  authDomain: "live-chat-3d2c3.firebaseapp.com",
  projectId: "live-chat-3d2c3",
  storageBucket: "live-chat-3d2c3.firebasestorage.app",
  messagingSenderId: "550798266942",
  appId: "1:550798266942:web:2ce678f70e4f64d6f7376f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();
await signInAnonymously(auth);

const username = auth.currentUser.uid; // unique per session

// Elements
const chatDiv = document.getElementById("chat");
const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const clearBtn = document.getElementById("clearBtn");
const roomsDiv = document.getElementById("rooms");
const newRoomName = document.getElementById("newRoomName");
const newRoomPass = document.getElementById("newRoomPass");
const createRoomBtn = document.getElementById("createRoomBtn");
const deleteRoomBtn = document.getElementById("deleteRoomBtn");

let currentRoom = "General";
let unsubscribeMessages = null;
let roomCreators = {};

// Ensure General exists
const generalRoomDoc = doc(db,"rooms","General");
const generalSnap = await getDoc(generalRoomDoc);
if(!generalSnap.exists()){
  await setDoc(generalRoomDoc,{
    name:"General",
    password:"",
    creator:"system"
  });
}

// Load Rooms
function loadRooms(){
  onSnapshot(collection(db,"rooms"), snap=>{
    roomsDiv.innerHTML="";
    snap.forEach(d=>{
      const r = d.data();
      roomCreators[r.name] = r.creator;

      const div = document.createElement("div");
      div.className="room";
      if(r.name===currentRoom) div.classList.add("selected");
      div.textContent=r.name;
      div.onclick=()=>joinRoom(r.name,r.password);

      roomsDiv.appendChild(div);
    });
  });
}
loadRooms();

// Join Room
function joinRoom(name,pass){
  if(pass){
    const entered = prompt("Enter password for "+name);
    if(entered!==pass) return alert("Wrong password");
  }

  currentRoom = name;
  listenMessages();
  highlightRoom();
}

// Highlight selected room
function highlightRoom(){
  document.querySelectorAll(".room").forEach(r=>{
    if(r.textContent===currentRoom){
      r.classList.add("selected");
    } else {
      r.classList.remove("selected");
    }
  });
}

// Listen to messages (room filtered)
function listenMessages(){
  if(unsubscribeMessages) unsubscribeMessages();

  chatDiv.innerHTML="";

  const q = query(
    collection(db,"messages"),
    where("room","==",currentRoom),
    orderBy("createdAt")
  );

  unsubscribeMessages = onSnapshot(q,snap=>{
    chatDiv.innerHTML="";
    snap.forEach(docSnap=>{
      const m = docSnap.data();

      const div = document.createElement("div");
      div.className="message "+(m.sender===username?"mine":"other");
      div.innerHTML=`<div class="sender">${m.sender}</div>${m.text}`;

      chatDiv.appendChild(div);
    });

    chatDiv.scrollTop = chatDiv.scrollHeight;
  });
}

joinRoom("General","");

// Send Message
async function sendMessage(){
  const text = messageInput.value.trim();
  if(!text) return;

  await addDoc(collection(db,"messages"),{
    text,
    sender:username,
    room:currentRoom,
    createdAt:serverTimestamp()
  });

  messageInput.value="";
}
sendBtn.addEventListener("click",sendMessage);
messageInput.addEventListener("keypress",e=>{
  if(e.key==="Enter") sendMessage();
});

// Clear Chat (permanent)
clearBtn.addEventListener("click", async ()=>{
  if(!confirm("Clear all messages in this room?")) return;

  const snap = await getDocs(
    query(collection(db,"messages"), where("room","==",currentRoom))
  );

  for(const d of snap.docs){
    await deleteDoc(d.ref);
  }
});

// Create Room
createRoomBtn.addEventListener("click", async ()=>{
  const name = newRoomName.value.trim();
  const pass = newRoomPass.value.trim();

  if(!name) return alert("Enter room name");

  await setDoc(doc(db,"rooms",name),{
    name,
    password:pass,
    creator:username
  });

  newRoomName.value="";
  newRoomPass.value="";

  joinRoom(name,pass);
});

// Delete Room
deleteRoomBtn.addEventListener("click", async ()=>{
  if(currentRoom==="General"){
    return alert("Cannot delete General room");
  }

  if(roomCreators[currentRoom]!==username){
    return alert("Only the creator can delete this room");
  }

  if(!confirm(`Delete "${currentRoom}" and all messages?`)) return;

  // delete messages first
  const snap = await getDocs(
    query(collection(db,"messages"), where("room","==",currentRoom))
  );

  for(const d of snap.docs){
    await deleteDoc(d.ref);
  }

  await deleteDoc(doc(db,"rooms",currentRoom));

  joinRoom("General","");
});
</script>