<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Class Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#eef3fb;
  --sidebar:#dde7f7;
  --card:#ffffff;
  --me:#bcd7ff;
  --other:#e7efff;
  --accent:#6f9df6;
  --text:#1f2937;
  --muted:#6b7280;
}

*{box-sizing:border-box;margin:0;padding:0;font-family:"Inter",sans-serif}
body{height:100vh;display:flex;background:var(--bg);color:var(--text)}

#sidebar{
  width:240px;
  background:var(--sidebar);
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:12px;
}

h2{font-size:1rem}

.room,.user{
  padding:8px;
  border-radius:8px;
  background:#cfe0fb;
  cursor:pointer;
}

.room.active{background:var(--accent);color:#fff}

#chat-wrap{flex:1;display:flex;flex-direction:column}

#chat{
  flex:1;
  padding:12px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:6px;
}

.msg{
  max-width:70%;
  padding:10px 14px;
  border-radius:14px;
}

.me{align-self:flex-end;background:var(--me)}
.other{align-self:flex-start;background:var(--other)}

.meta{font-size:.7rem;color:var(--muted);margin-bottom:2px}

#typing{
  font-size:.75rem;
  color:var(--muted);
  padding-left:12px;
}

#form{
  display:flex;
  gap:6px;
  padding:10px;
  background:var(--sidebar);
}

#message{
  flex:1;
  padding:10px;
  border-radius:8px;
  border:1px solid #c7d2fe;
}

button{
  padding:10px 14px;
  border:none;
  border-radius:8px;
  background:var(--accent);
  color:#fff;
  font-weight:600;
}

@media(max-width:700px){
  #sidebar{width:150px}
}
</style>
</head>

<body>

<div id="sidebar">
  <h2>Rooms</h2>
  <div id="rooms"></div>
  <input id="roomName" placeholder="New room" />
  <button id="addRoom">Create</button>

  <h2>Online</h2>
  <div id="users"></div>
</div>

<div id="chat-wrap">
  <div id="chat"></div>
  <div id="typing"></div>
  <form id="form">
    <input id="message" placeholder="Type a message…" />
    <button>Send</button>
    <button type="button" id="clear">Clear</button>
  </form>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyD9GQMi0v4ItnkJ2uqKtUUQU59DorLrCAg",
  authDomain:"live-chat-3d2c3.firebaseapp.com",
  projectId:"live-chat-3d2c3"
});

const db=firebase.firestore();
const id=crypto.randomUUID();

let username=localStorage.getItem("username");
if(!username){
  username="User"+Math.floor(Math.random()*10000);
  localStorage.setItem("username",username);
}

let room="General";
let unsub=null;

const chat=document.getElementById("chat");
const typingEl=document.getElementById("typing");

function loadRoom(r){
  room=r;
  chat.innerHTML="";
  if(unsub)unsub();
  unsub=db.collection("messages")
    .where("room","==",room)
    .orderBy("time")
    .onSnapshot(s=>{
      chat.innerHTML="";
      s.forEach(d=>{
        const m=d.data();
        const div=document.createElement("div");
        div.className="msg "+(m.sender===username?"me":"other");
        div.innerHTML=`<div class="meta">${m.sender}</div>${m.text}`;
        chat.appendChild(div);
      });
      chat.scrollTop=chat.scrollHeight;
    });
}

db.collection("rooms").onSnapshot(s=>{
  const r=document.getElementById("rooms");
  r.innerHTML="";
  s.forEach(d=>{
    const div=document.createElement("div");
    div.className="room"+(d.id===room?" active":"");
    div.textContent=d.id;
    div.onclick=()=>loadRoom(d.id);
    r.appendChild(div);
  });
});

db.collection("rooms").doc("General").set({ok:true});

document.getElementById("addRoom").onclick=()=>{
  const n=document.getElementById("roomName").value.trim();
  if(n)db.collection("rooms").doc(n).set({ok:true});
};

document.getElementById("form").onsubmit=e=>{
  e.preventDefault();
  const t=message.value.trim();
  if(!t)return;
  db.collection("messages").add({room,text:t,sender:username,time:Date.now()});
  message.value="";
};

message.oninput=()=>{
  db.collection("typing").doc(room).set({user:username});
};

db.collection("typing").doc(room).onSnapshot(d=>{
  if(d.exists&&d.data().user!==username){
    typingEl.textContent=d.data().user+" is typing…";
    setTimeout(()=>typingEl.textContent="",1500);
  }
});

document.getElementById("clear").onclick=()=>chat.innerHTML="";

db.collection("online").doc(id).set({name:username});
db.collection("online").onSnapshot(s=>{
  users.innerHTML="";
  s.forEach(d=>{
    const div=document.createElement("div");
    div.className="user";
    div.textContent=d.data().name;
    users.appendChild(div);
  });
});

loadRoom("General");
</script>

</body>
</html>