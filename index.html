<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Class Chat Live</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
/* ------------------ Base ------------------ */
body, html { margin:0; padding:0; font-family:"Georgia", sans-serif; height:100%; display:flex; }
#sidebar { width:220px; background:#4b3b77; color:#fff; display:flex; flex-direction:column; padding:12px; box-sizing:border-box; }
#main { flex:1; display:flex; flex-direction:column; background:#1e1b2d; color:#dcd6f7; }
h2 { margin:0 0 8px 0; font-size:1rem; text-align:center; }
button { cursor:pointer; border:none; border-radius:4px; }

/* ------------------ Sidebar ------------------ */
#rooms, #users { margin-bottom:16px; }
#rooms select, #rooms input { width:100%; margin-bottom:6px; padding:6px; border-radius:4px; border:none; }
#users { font-size:0.9rem; }
.user-online { margin-bottom:4px; }

/* ------------------ Chat ------------------ */
#chat { flex:1; overflow-y:auto; padding:12px; scrollbar-width: thin; scrollbar-color: #7fa1ff #2b2244; }
#chat::-webkit-scrollbar { width:8px; }
#chat::-webkit-scrollbar-thumb { background-color:#7fa1ff; border-radius:4px; }
.msg { margin-bottom:10px; padding:8px 12px; border-radius:6px; max-width:85%; word-wrap:break-word; color:#e0d9ff; background:#3a2e66; position:relative; }
.msg.me { background:#5a7fff; margin-left:auto; color:#fff; }
.meta { font-size:0.75rem; opacity:0.7; margin-bottom:2px; display:flex; align-items:center; gap:6px; }
.avatar { width:20px; height:20px; border-radius:50%; background:#b49fff; display:inline-block; }
.typing { font-style:italic; font-size:0.85rem; opacity:0.8; position:absolute; bottom:-16px; }

/* ------------------ Form ------------------ */
#form { display:flex; padding:10px; background:#4b3b77; gap:6px; }
#username, #message { padding:10px; border-radius:4px; border:none; font-size:1rem; }
#username { width:120px; }
#message { flex:1; }

/* Buttons */
#send { background:#7fa1ff; color:#111b33; font-weight:bold; padding:10px 16px; }
#clear { background:#b49fff; color:#111b33; font-weight:bold; padding:10px 16px; }

/* ------------------ Timeout Room ------------------ */
#timeout { display:none; flex-direction:column; align-items:center; justify-content:center; background:url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1400&q=80') no-repeat center center/cover; color:#fff; text-shadow:1px 1px 4px #000; font-size:1.2rem; height:100%; }
</style>
</head>
<body>
<div id="sidebar">
  <h2>Chat Rooms</h2>
  <div id="rooms">
    <select id="roomSelect"><option value="general">General</option></select>
    <input id="newRoom" placeholder="Private room name">
    <input id="roomPass" placeholder="Private password">
    <button id="createRoom">Create/Join Private</button>
  </div>
  <h2>Online Users</h2>
  <div id="users"></div>
  <button id="kickBtn">Kick User (slay)</button>
</div>

<div id="main">
  <div id="chat"></div>
  <form id="form">
    <input id="username" placeholder="Username">
    <input id="message" placeholder="Type a message..." autocomplete="off">
    <button id="send" type="submit">Send</button>
    <button id="clear" type="button">Clear Chat</button>
  </form>
</div>

<div id="timeout">⏱️ You’ve been timed out!</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyD9GQMi0v4ItnkJ2uqKtUUQU59DorLrCAg",
  authDomain: "live-chat-3d2c3.firebaseapp.com",
  projectId: "live-chat-3d2c3",
  storageBucket: "live-chat-3d2c3.firebasestorage.app",
  messagingSenderId: "550798266942",
  appId: "1:550798266942:web:2ce678f70e4f64d6f7376f",
  measurementId: "G-L0K72L8894"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ------------------ State ------------------
let currentRoom = "general";
let username = "";
let onlineUsers = {};
let typingUsers = {};
let kicked = false;

// ------------------ DOM ------------------
const chatEl = document.getElementById("chat");
const formEl = document.getElementById("form");
const msgInput = document.getElementById("message");
const userInput = document.getElementById("username");
const roomSelect = document.getElementById("roomSelect");
const newRoomInput = document.getElementById("newRoom");
const roomPassInput = document.getElementById("roomPass");
const createRoomBtn = document.getElementById("createRoom");
const usersEl = document.getElementById("users");
const clearBtn = document.getElementById("clear");
const kickBtn = document.getElementById("kickBtn");
const timeoutEl = document.getElementById("timeout");

// ------------------ Helper ------------------
function addMessage(msg, isMe){
  const wrap = document.createElement("div");
  wrap.className = "msg" + (isMe ? " me" : "");
  const meta = document.createElement("div");
  meta.className = "meta";
  meta.innerHTML = `<span class="avatar"></span>${msg.name} • ${new Date(msg.time).toLocaleTimeString()}`;
  const text = document.createElement("div");
  text.className = "text";
  text.textContent = msg.text;
  wrap.appendChild(meta);
  wrap.appendChild(text);
  chatEl.appendChild(wrap);
  chatEl.scrollTop = chatEl.scrollHeight;
}

// ------------------ Typing ------------------
msgInput.addEventListener("input", ()=>{
  db.collection("typing").doc(currentRoom).set({[username]: true});
  setTimeout(()=>db.collection("typing").doc(currentRoom).set({[username]: false}), 2000);
});

// ------------------ Online Users ------------------
function updateOnlineUsers(){
  usersEl.innerHTML="";
  for(let u in onlineUsers) {
    const div = document.createElement("div");
    div.textContent = u;
    div.className="user-online";
    usersEl.appendChild(div);
  }
}

// ------------------ Room Join ------------------
createRoomBtn.addEventListener("click", ()=>{
  const roomName = newRoomInput.value.trim();
  const roomPass = roomPassInput.value.trim();
  if(!roomName || !roomPass) return alert("Enter room name & password");
  currentRoom = roomName;
  if(!Array.from(roomSelect.options).some(o=>o.value===roomName)){
    const opt = document.createElement("option"); opt.value=roomName; opt.textContent=roomName;
    roomSelect.appendChild(opt);
  }
  roomSelect.value=currentRoom;
});

// ------------------ Firestore ------------------
function sendMessage(text){
  db.collection("messages").add({name: username, text, time:Date.now(), room: currentRoom});
}

function loadMessages(){
  db.collection("messages").where("room","==",currentRoom).orderBy("time")
  .onSnapshot(snapshot=>{
    chatEl.innerHTML="";
    snapshot.forEach(doc=>{
      const msg = doc.data();
      addMessage(msg, msg.name===username);
    });
  });
}

// ------------------ Form ------------------
formEl.addEventListener("submit", e=>{
  e.preventDefault();
  if(kicked) return;
  username = userInput.value.trim() || "anon";
  const text = msgInput.value.trim();
  if(!text) return;
  sendMessage(text);
  msgInput.value="";
});
clearBtn.addEventListener("click", ()=>{ chatEl.innerHTML=""; });

// ------------------ Kick ------------------
kickBtn.addEventListener("click", ()=>{
  const targetUser = prompt("Enter username to kick:");
  const pass = prompt("Enter kick password:");
  if(pass!=="slay") return alert("Wrong password");
  if(targetUser===username){ kicked=true; showTimeout(); return; }
  db.collection("kicked").doc(targetUser).set({room: "timeout"});
});

function showTimeout(){
  document.getElementById("main").style.display="none";
  timeoutEl.style.display="flex";
}

// ------------------ Listen Kicked ------------------
db.collection("kicked").doc(username)
.onSnapshot(doc=>{
  if(doc.exists){ kicked=true; showTimeout(); }
});

// ------------------ Real-time ------------------
db.collection("messages").where("room","==",currentRoom).orderBy("time")
.onSnapshot(snapshot=>{
  chatEl.innerHTML="";
  snapshot.forEach(doc=>{ addMessage(doc.data(), doc.data().name===username); });
});

// ------------------ Online Users ------------------
onlineUsers[username]="online";
updateOnlineUsers();
</script>
</body>
</html>