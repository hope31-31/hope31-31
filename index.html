<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Class Chat Live</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  /* GENERAL LAYOUT */
  html, body { margin:0; padding:0; height:100%; font-family:"Georgia", sans-serif; background:#1e1b2d; color:#dcd6f7; display:flex; }
  #sidebar { width:150px; background:#2b2244; padding:10px; display:flex; flex-direction:column; }
  #sidebar h3 { margin:0 0 10px; font-size:1rem; }
  #onlineUsers { flex:1; overflow-y:auto; }
  #onlineUsers div { margin-bottom:6px; font-size:0.9rem; display:flex; align-items:center; gap:6px; }
  .avatar { width:20px; height:20px; border-radius:50%; background:#7fa1ff; text-align:center; line-height:20px; font-size:0.8rem; color:#fff; }

  #main { flex:1; display:flex; flex-direction:column; }
  header { padding:8px 12px; background:#4b3b77; display:flex; justify-content:space-between; align-items:center; font-size:1rem; }
  #roomControls { display:flex; gap:6px; }
  input, select { padding:4px 6px; border-radius:4px; border:none; font-size:0.9rem; }

  #chat { flex:1; overflow-y:auto; padding:12px 8px; }
  .msg { margin-bottom:8px; padding:6px 8px; border-radius:6px; background:#3a2e66; max-width:80%; word-wrap:break-word; }
  .me { background:#5a7fff; margin-left:auto; color:#fff; }
  .meta { font-size:0.7rem; opacity:0.7; margin-bottom:2px; }
  .text { font-size:0.9rem; }

  #typing { font-size:0.8rem; opacity:0.7; padding-left:8px; }

  #form { display:flex; padding:8px; background:#4b3b77; gap:6px; }
  #message { flex:1; padding:6px; border-radius:4px; border:1px solid #6658a8; background:#2b2244; color:#e0d9ff; font-size:0.9rem; }
  button { padding:6px 10px; border:none; border-radius:4px; background:#7fa1ff; color:#111b33; font-weight:bold; font-size:0.9rem; cursor:pointer; }
  button:disabled { opacity:0.5; cursor:default; }

  /* MOBILE ADJUSTMENTS */
  @media(max-width:600px){
    #sidebar { display:none; }
    header { flex-direction:column; gap:6px; }
  }
</style>
</head>
<body>

<div id="sidebar">
  <h3>Online Users</h3>
  <div id="onlineUsers"></div>
</div>

<div id="main">
<header>
  <div>
    Name: <input id="username" placeholder="You">
    <input type="file" id="avatarInput">
  </div>
  <div id="roomControls">
    <input id="newRoom" placeholder="Room name">
    <input id="roomPass" placeholder="Password (optional)">
    <button id="joinRoom">Join/Create</button>
    <button id="clear">Clear Chat</button>
  </div>
</header>

<div id="chat"></div>
<div id="typing"></div>

<form id="form">
  <input id="message" autocomplete="off" placeholder="Type a message...">
  <button id="send" type="submit">Send</button>
</form>
  
<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
  // ðŸ”¥ Your Firebase config ðŸ”¥
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_ID",
    appId: "YOUR_APP_ID",
    measurementId: "YOUR_MEASUREMENT_ID"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const rtdb = firebase.database();

  // ELEMENTS
  const chatEl = document.getElementById("chat");
  const formEl = document.getElementById("form");
  const msgInput = document.getElementById("message");
  const userInput = document.getElementById("username");
  const onlineEl = document.getElementById("onlineUsers");
  const typingEl = document.getElementById("typing");
  const avatarInput = document.getElementById("avatarInput");
  const roomInput = document.getElementById("newRoom");
  const roomPassInput = document.getElementById("roomPass");

  let currentRoom = "General";
  let username = "";
  let avatarURL = "";
  let typingTimeout;

  const TEACHER_PASSWORD = "Baddie";

  // SAVE AVATAR LOCALLY
  avatarInput.addEventListener("change", e=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{ avatarURL = reader.result; };
    reader.readAsDataURL(file);
  });

  // ROOM JOIN
  document.getElementById("joinRoom").onclick = ()=>{
    const roomName = roomInput.value.trim();
    const pass = roomPassInput.value.trim();
    if(!roomName) return alert("Enter room name");
    const storedPass = localStorage.getItem(`room-${roomName}-pass`);
    if(storedPass && storedPass !== pass){
      return alert("Wrong password!");
    }
    if(pass) localStorage.setItem(`room-${roomName}-pass`, pass);
    currentRoom = roomName;
    chatEl.innerHTML="";
    loadMessages();
  };

  // ONLINE USERS TRACKING
  function updateOnlineUsers(list){
    onlineEl.innerHTML = "";
    list.forEach(u=>{
      const div = document.createElement("div");
      const avatar = document.createElement("div");
      avatar.className="avatar";
      if(u.avatar) avatar.style.backgroundImage=`url(${u.avatar})`;
      else avatar.textContent = u.name[0].toUpperCase();
      div.appendChild(avatar);
      div.appendChild(document.createTextNode(u.name));
      onlineEl.appendChild(div);
    });
  }

  function setOnlineStatus(){
    username = userInput.value.trim()||"anon";
    const userRef = rtdb.ref(`online/${username}`);
    userRef.set({name:username, avatar:avatarURL, room:currentRoom});
    userRef.onDisconnect().remove();
  }
  setOnlineStatus();

  // ADD MESSAGE
  function addMessage(msg, isMe){
    const wrap = document.createElement("div");
    wrap.className="msg"+(isMe?" me":"");
    const meta=document.createElement("div"); meta.className="meta";
    meta.textContent=msg.name+" â€¢ "+new Date(msg.time).toLocaleTimeString();
    const text=document.createElement("div"); text.className="text"; text.textContent=msg.text;
    wrap.appendChild(meta); wrap.appendChild(text);
    chatEl.appendChild(wrap); chatEl.scrollTop=chatEl.scrollHeight;
  }

  // TYPING INDICATOR
  msgInput.addEventListener("input", ()=>{
    rtdb.ref(`typing/${currentRoom}/${username}`).set(true);
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(()=>{
      rtdb.ref(`typing/${currentRoom}/${username}`).remove();
    },1000);
  });

  // SEND MESSAGE
  formEl.addEventListener("submit", e=>{
    e.preventDefault();
    if(!msgInput.value.trim()) return;
    const msg={name:username,text:msgInput.value.trim(),time:Date.now(),room:currentRoom, avatar:avatarURL};
    db.collection("messages").add(msg);
    msgInput.value="";
  });

  // CLEAR CHAT (only local)
  document.getElementById("clear").onclick = ()=>{
    chatEl.innerHTML="";
  };

  // LOAD MESSAGES
  function loadMessages(){
    db.collection("messages").where("room","==",currentRoom).orderBy("time")
    .onSnapshot(snapshot=>{
      chatEl.innerHTML="";
      snapshot.forEach(doc=>{
        const msg=doc.data();
        addMessage(msg,msg.name===username);
      });
    });
  }
  loadMessages();

  // ONLINE USERS LIST
  rtdb.ref("online").on("value", snap=>{
    const users=[];
    snap.forEach(u=>{ if(u.val().room===currentRoom) users.push(u.val()); });
    updateOnlineUsers(users);
  });

  // TYPING INDICATOR DISPLAY
  rtdb.ref(`typing/${currentRoom}`).on("value", snap=>{
    const names=[];
    snap.forEach(c=>names.push(c.key));
    typingEl.textContent = names.length? names.join(", ")+" is typing..." : "";
  });

</script>
</body>
</html>