<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Live Class Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  html, body {
    margin:0; padding:0; height:100%;
    font-family: "Helvetica Neue", sans-serif;
    background: linear-gradient(135deg, #a18cd1, #fbc2eb);
    color:#001f4d;
    display:flex;
    flex-direction:column;
  }
  header {
    padding:12px 16px;
    background:#6a5acd;
    display:flex;
    justify-content:space-between;
    align-items:center;
    color:white;
    flex-wrap:wrap;
  }
  header input {
    padding:6px 8px;
    border-radius:6px;
    border:none;
    margin-right:6px;
  }
  #chat {
    flex:1;
    overflow-y:auto;
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .msg {
    max-width:70%;
    padding:8px 12px;
    border-radius:12px;
    display:flex;
    flex-direction:column;
    word-wrap:break-word;
    background: rgba(255,255,255,0.8);
    color:#001f4d;
  }
  .me { align-self:flex-end; background:#6a5acd; color:white; }
  .meta { font-size:0.75rem; opacity:0.7; margin-bottom:4px; display:flex; align-items:center; gap:4px; }
  .text { font-size:1rem; word-break:break-word; }
  #form {
    display:flex;
    padding:10px;
    gap:6px;
    background:rgba(255,255,255,0.7);
    border-top:2px solid #6a5acd;
  }
  #message {
    flex:1;
    padding:10px;
    border-radius:8px;
    border:1px solid #6a5acd;
    font-size:1rem;
  }
  button {
    padding:10px 14px;
    border:none;
    border-radius:8px;
    background:#6a5acd;
    color:white;
    font-weight:bold;
    cursor:pointer;
  }
  button:disabled { opacity:0.5; cursor:default; }
  #sidebar {
    position:fixed;
    right:0;
    top:0;
    width:200px;
    height:100%;
    background:rgba(255,255,255,0.9);
    border-left:2px solid #6a5acd;
    padding:10px;
    overflow-y:auto;
  }
  #onlineUsers div { margin-bottom:6px; display:flex; align-items:center; gap:6px; }
  #onlineUsers img { width:28px; height:28px; border-radius:50%; object-fit:cover; }
  .typing { font-style:italic; opacity:0.6; font-size:0.85rem; }
  @media(max-width:600px){
    #sidebar { width:140px; font-size:0.8rem; }
    header input, #message { font-size:0.85rem; padding:6px; }
    button { padding:8px 10px; font-size:0.85rem; }
  }
</style>
</head>
<body>

<header>
  <div>
    Username: <input id="username" placeholder="you">
    Avatar: <input type="file" id="avatarInput" accept="image/*">
  </div>
  <div>
    <input id="roomName" placeholder="Room name">
    <input id="roomPass" placeholder="Password (private)">
    <button id="joinRoom">Join/Create Room</button>
  </div>
</header>

<div id="chat"></div>

<form id="form">
  <input id="message" autocomplete="off" placeholder="Type a message...">
  <button type="submit">Send</button>
  <button type="button" id="clearChat">Clear Chat</button>
</form>

<div id="sidebar">
  <h4>Online Users</h4>
  <div id="onlineUsers"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "YOUR_FIREBASE_API_KEY",
  authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
  projectId: "YOUR_FIREBASE_PROJECT_ID",
  storageBucket: "YOUR_FIREBASE_STORAGE_BUCKET",
  messagingSenderId: "YOUR_FIREBASE_MESSAGING_ID",
  appId: "YOUR_FIREBASE_APP_ID"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

const chatEl = document.getElementById("chat");
const formEl = document.getElementById("form");
const msgInput = document.getElementById("message");
const usernameInput = document.getElementById("username");
const avatarInput = document.getElementById("avatarInput");
const clearBtn = document.getElementById("clearChat");
const joinRoomBtn = document.getElementById("joinRoom");
const roomNameInput = document.getElementById("roomName");
const roomPassInput = document.getElementById("roomPass");
const onlineUsersEl = document.getElementById("onlineUsers");

let currentRoom = "General";
let user = {name:"anon", avatar:"https://via.placeholder.com/50"};
const kickPassword = "slay";

// Load avatar
avatarInput.addEventListener("change", async e=>{
  const file = e.target.files[0];
  if(!file) return;
  const ref = storage.ref("avatars/"+Date.now()+"_"+file.name);
  await ref.put(file);
  user.avatar = await ref.getDownloadURL();
});

// Join/Create Room
joinRoomBtn.addEventListener("click", ()=>{
  currentRoom = roomNameInput.value || "General";
  listenMessages();
  listenUsers();
  chatEl.innerHTML="";
});

// Add message
function addMessage(msg, isMe){
  const wrap = document.createElement("div");
  wrap.className = "msg"+(isMe?" me":"");
  const meta = document.createElement("div");
  meta.className="meta";
  meta.innerHTML = `<img src="${msg.avatar}" alt="avatar"> ${msg.name} <span class="typing">...</span>`;
  const text = document.createElement("div");
  text.className="text";
  text.textContent = msg.text;
  wrap.appendChild(meta);
  wrap.appendChild(text);
  chatEl.appendChild(wrap);
  chatEl.scrollTop = chatEl.scrollHeight;
}

// Clear chat
clearBtn.addEventListener("click", ()=>{ chatEl.innerHTML=""; });

// Typing indicator
msgInput.addEventListener("input", ()=>{
  db.collection("rooms").doc(currentRoom).collection("typing").doc(user.name).set({typing:true});
  setTimeout(()=>{ db.collection("rooms").doc(currentRoom).collection("typing").doc(user.name).delete(); }, 1000);
});

// Send message
formEl.addEventListener("submit", e=>{
  e.preventDefault();
  if(!msgInput.value.trim()) return;
  db.collection("rooms").doc(currentRoom).collection("messages").add({
    name:user.name||usernameInput.value||"anon",
    text: msgInput.value,
    avatar: user.avatar,
    time: Date.now()
  });
  msgInput.value="";
});

// Listen messages
function listenMessages(){
  db.collection("rooms").doc(currentRoom).collection("messages").orderBy("time")
    .onSnapshot(snapshot=>{
      chatEl.innerHTML="";
      snapshot.forEach(doc=>{
        const msg = doc.data();
        addMessage(msg, msg.name===user.name);
      });
    });
}

// Online users
function listenUsers(){
  const onlineRef = db.collection("rooms").doc(currentRoom).collection("online");
  const userDoc = onlineRef.doc(user.name);
  userDoc.set({avatar:user.avatar, joined:Date.now()});
  userDoc.onSnapshot(()=>{
    onlineRef.get().then(snap=>{
      onlineUsersEl.innerHTML="";
      snap.forEach(doc=>{
        const u = doc.data();
        const div = document.createElement("div");
        div.innerHTML=`<img src="${u.avatar}" alt="avatar"> ${doc.id}`;
        onlineUsersEl.appendChild(div);
      });
    });
  });
  window.addEventListener("beforeunload", ()=>{ userDoc.delete(); });
}

user.name=usernameInput.value||"anon";
listenMessages();
listenUsers();
</script>
</body>
</html>