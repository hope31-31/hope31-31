<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Class Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --bg:#14122a;
  --panel:#221f3d;
  --accent:#8b9dff;
  --bubble:#2f2c55;
  --me:#6f86ff;
}

*{box-sizing:border-box}
html,body{
  margin:0;height:100%;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:linear-gradient(160deg,#14122a,#1e1b3a);
  color:#eee;
}
body{display:flex;flex-direction:column}

header{
  padding:10px;
  background:rgba(34,31,61,.95);
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  align-items:center;
}

header input,header select{
  background:#2b2752;
  border:none;
  padding:8px 10px;
  border-radius:10px;
  color:white;
}

header button{
  background:var(--accent);
  border:none;
  border-radius:10px;
  padding:8px 12px;
  font-weight:600;
}

#chat{
  flex:1;
  padding:14px;
  overflow-y:auto;
}

.msg{
  max-width:80%;
  background:var(--bubble);
  padding:10px 12px;
  border-radius:16px;
  margin-bottom:10px;
  box-shadow:0 4px 10px rgba(0,0,0,.3);
}
.me{margin-left:auto;background:linear-gradient(135deg,var(--me),#9aa8ff)}

.meta{font-size:.75rem;opacity:.7;margin-bottom:4px}

#typing{
  padding:6px 14px;
  font-size:.85rem;
  opacity:.7;
}

#online{
  padding:8px 12px;
  background:#1e1b35;
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}

.user{
  padding:5px 10px;
  border-radius:999px;
  background:#2d2a52;
  font-size:.85rem;
}

#form{
  display:flex;
  gap:6px;
  padding:10px;
  background:rgba(34,31,61,.95);
}

#message{
  flex:1;
  padding:10px;
  border-radius:14px;
  border:none;
  background:#2b2752;
  color:white;
}

#send{
  padding:10px 14px;
  border:none;
  border-radius:14px;
  background:var(--accent);
  font-weight:600;
}

@media(max-width:480px){
  header input,header select,header button{font-size:.85rem}
  #message,#send{font-size:.9rem}
}
</style>
</head>

<body>

<header>
  <input id="username" placeholder="name">
  <input id="avatar" placeholder="emoji ðŸ˜ˆâœ¨ðŸ’€">
  <select id="room"></select>
</header>

<div id="chat"></div>
<div id="typing"></div>
<div id="online"></div>

<form id="form">
  <input id="message" placeholder="Messageâ€¦" autocomplete="off">
  <button id="send">Send</button>
</form>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyD9GQMi0v4ItnkJ2uqKtUUQU59DorLrCAg",
  authDomain: "live-chat-3d2c3.firebaseapp.com",
  projectId: "live-chat-3d2c3"
});
const db=firebase.firestore();

const user=document.getElementById("username");
const avatar=document.getElementById("avatar");
const room=document.getElementById("room");
const chat=document.getElementById("chat");
const typingEl=document.getElementById("typing");
const online=document.getElementById("online");
const msg=document.getElementById("message");

user.value=localStorage.getItem("name")||"";
avatar.value=localStorage.getItem("avatar")||"ðŸ™‚";
user.oninput=()=>localStorage.setItem("name",user.value);
avatar.oninput=()=>localStorage.setItem("avatar",avatar.value);

const pid=Math.random().toString(36).slice(2);
room.innerHTML='<option value="general">General</option>';

function loadRoom(){
  chat.innerHTML="";
  typingEl.textContent="";

  const pres=db.collection("presence").doc(pid);
  pres.set({name:user.value,avatar:avatar.value,room:room.value,typing:false});
  window.onbeforeunload=()=>pres.delete();

  db.collection("messages")
   .where("room","==",room.value)
   .orderBy("time")
   .onSnapshot(s=>{
    chat.innerHTML="";
    s.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      div.className="msg"+(m.name===user.value?" me":"");
      div.innerHTML=`<div class="meta">${m.avatar} ${m.name}</div>${m.text}`;
      chat.appendChild(div);
    });
    chat.scrollTop=chat.scrollHeight;
   });

  db.collection("presence")
   .where("room","==",room.value)
   .onSnapshot(s=>{
    online.innerHTML="";
    typingEl.textContent="";
    s.forEach(d=>{
      const p=d.data();
      const u=document.createElement("span");
      u.className="user";
      u.textContent=p.avatar+" "+p.name;
      online.appendChild(u);

      if(p.typing && p.name!==user.value){
        typingEl.textContent=`${p.name} is typingâ€¦`;
      }
    });
   });
}
loadRoom();

let typingTimeout;
msg.oninput=()=>{
  const ref=db.collection("presence").doc(pid);
  ref.update({typing:true});
  clearTimeout(typingTimeout);
  typingTimeout=setTimeout(()=>ref.update({typing:false}),1200);
};

document.getElementById("form").onsubmit=e=>{
  e.preventDefault();
  if(!msg.value.trim())return;
  db.collection("messages").add({
    name:user.value||"anon",
    avatar:avatar.value,
    text:msg.value,
    room:room.value,
    time:Date.now()
  });
  msg.value="";
  db.collection("presence").doc(pid).update({typing:false});
};
</script>

</body>
</html>