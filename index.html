<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ultimate Class Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#eef3ff;
  --panel:#dbe6ff;
  --card:#ffffff;
  --me:#a8c7ff;
  --other:#e7edff;
  --accent:#5b7cfa;
}

*{box-sizing:border-box;font-family:Inter}
body{margin:0;height:100vh;display:flex;background:var(--bg)}

#sidebar{
  width:240px;
  background:var(--panel);
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

h2{margin:4px 0}

button{
  padding:6px;
  border:none;
  border-radius:6px;
  background:var(--accent);
  color:white;
  font-weight:600;
  cursor:pointer;
}

.room, .user{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  background:white;
  padding:6px 8px;
  border-radius:6px;
  margin-bottom:6px;
  cursor:pointer;
}

.room.selected, .user.selected{background:var(--accent); color:white;}
.avatar{
  width:32px;height:32px;
  border-radius:50%;
  background:var(--accent);
  color:white;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
}

#chat-wrap{
  flex:1;
  display:flex;
  flex-direction:column;
}

#chat{
  flex:1;
  padding:12px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:6px;
}

.msg{
  max-width:70%;
  padding:10px;
  border-radius:14px;
}

.me{align-self:flex-end;background:var(--me);}
.other{align-self:flex-start;background:var(--other);}

.meta{font-size:12px;opacity:.6}

#typing{font-size:12px;font-style:italic;margin-left:12px}

form{
  display:flex;
  gap:6px;
  padding:10px;
  background:var(--panel);
}

input{
  flex:1;
  padding:10px;
  border-radius:6px;
  border:1px solid #aaa;
}
</style>
</head>
<body>

<div id="sidebar">
  <h2>Rooms</h2>
  <div id="rooms"></div>
  <input id="new-room-name" placeholder="Private room name">
  <input id="new-room-pass" type="password" placeholder="Password">
  <button id="create-room">Create Private Room</button>

  <h2>Online Users</h2>
  <div id="users"></div>
  <button onclick="invite()">Invite Friend</button>
  <button onclick="clearChat()">Clear Chat</button>
</div>

<div id="chat-wrap">
  <div id="chat"></div>
  <div id="typing"></div>
  <form id="form">
    <input id="msg" placeholder="Message‚Ä¶" autocomplete="off">
    <button>Send</button>
  </form>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
/* üîê CONFIG */
firebase.initializeApp({
  apiKey: "AIzaSyD9GQMi0v4ItnkJ2uqKtUUQU59DorLrCAg",
  authDomain: "live-chat-3d2c3.firebaseapp.com",
  projectId: "live-chat-3d2c3"
});
const db = firebase.firestore();

/* üë§ USERNAME */
let name = localStorage.getItem("name");
while(!name || name.trim().length<2){
  name = prompt("Choose a username (2+ letters)");
}
name = name.trim();
localStorage.setItem("name",name);

/* ROOMS */
let currentRoom = "General";
const roomsEl = document.getElementById("rooms");
const chatEl = document.getElementById("chat");
const usersEl = document.getElementById("users");
const typingEl = document.getElementById("typing");
const form = document.getElementById("form");
const msgInput = document.getElementById("msg");
const newRoomInput = document.getElementById("new-room-name");
const newRoomPass = document.getElementById("new-room-pass");
const createRoomBtn = document.getElementById("create-room");

function addRoomButton(name){
  const div=document.createElement("div");
  div.className="room";
  div.textContent=name;
  div.onclick=()=>joinRoom(name);
  roomsEl.appendChild(div);
}

/* Default General Room */
addRoomButton("General");

/* CREATE PRIVATE ROOM */
createRoomBtn.onclick=()=>{
  const r = newRoomInput.value.trim();
  const p = newRoomPass.value.trim();
  if(!r || !p) return alert("Enter name and password");
  db.collection("rooms").doc(r).set({password:p});
  addRoomButton(r);
  newRoomInput.value=""; newRoomPass.value="";
}

/* JOIN ROOM */
function joinRoom(r){
  if(r!=="General"){
    db.collection("rooms").doc(r).get().then(d=>{
      const pass=prompt("Enter password for "+r);
      if(!d.exists || pass!==d.data().password) return alert("Wrong password");
      currentRoom=r;
      listenMessages(r);
    });
  } else {
    currentRoom="General";
    listenMessages("General");
  }
  document.querySelectorAll(".room").forEach(rb=>rb.classList.remove("selected"));
  Array.from(roomsEl.children).forEach(rb=>{if(rb.textContent===r) rb.classList.add("selected")});
}

/* üü¢ ONLINE USERS */
const userRef = db.collection("online").doc(name);
userRef.set({name,room:currentRoom});
window.addEventListener("beforeunload",()=>userRef.delete());

db.collection("online").onSnapshot(s=>{
  usersEl.innerHTML="";
  s.forEach(d=>{
    const u=d.data().name;
    const div=document.createElement("div");
    div.className="user";
    div.innerHTML=`<div class="avatar">${u[0].toUpperCase()}</div>${u}`;
    usersEl.appendChild(div);
  });
});

/* üí¨ CHAT */
form.onsubmit=e=>{
  e.preventDefault();
  if(!msgInput.value.trim()) return;
  db.collection("messages").add({
    user:name,
    text:msgInput.value,
    room:currentRoom,
    time:Date.now()
  });
  msgInput.value="";
};

function listenMessages(room){
  chatEl.innerHTML="";
  db.collection("messages").where("room","==",room).orderBy("time")
    .onSnapshot(s=>{
      chatEl.innerHTML="";
      s.forEach(d=>{
        const m=d.data();
        const div=document.createElement("div");
        div.className=`msg ${m.user===name?"me":"other"}`;
        div.innerHTML=`<div class="meta">${m.user}</div>${m.text}`;
        chatEl.appendChild(div);
      });
      chatEl.scrollTop=chatEl.scrollHeight;
    });
}
listenMessages(currentRoom);

/* ‚úçÔ∏è TYPING */
msgInput.oninput=()=>{
  db.collection("typing").doc(name).set({typing:true,room:currentRoom});
  setTimeout(()=>db.collection("typing").doc(name).delete(),1000);
};
db.collection("typing").onSnapshot(s=>{
  const typingUsers = s.docs.filter(d=>d.id!==name && d.data().room===currentRoom);
  typingEl.textContent=typingUsers.length?"Someone is typing‚Ä¶":"";
});

/* üßπ CLEAR CHAT */
function clearChat(){ chatEl.innerHTML=""; }

/* üîó INVITE */
function invite(){ navigator.clipboard.writeText(location.href); alert("Invite link copied üíå"); }
</script>
</body>
</html>