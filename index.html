<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Educational Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<style>
body { margin:0; font-family: 'Poppins', Arial, sans-serif; background: linear-gradient(135deg,#1e1e2f,#2c2c54); color:white; display:flex; flex-direction:column; height:100vh;}
header { padding:15px; text-align:center; font-size:18px; font-weight:600; background:rgba(0,0,0,0.3);}
#rooms { display:flex; gap:5px; padding:5px 10px; overflow-x:auto; background:rgba(0,0,0,0.2);}
.room { padding:5px 10px; background:#6366f1; border-radius:12px; cursor:pointer; white-space:nowrap; font-weight:500; position: relative;}
.room.selected { background:#4f46e5; }
#chat { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; }
.message { max-width:70%; margin:5px; padding:10px; border-radius:15px; word-wrap: break-word; }
.sender { font-size:12px; opacity:0.7; margin-bottom:2px; }
.mine { background:#4f46e5; align-self:flex-end; }
.other { background:#2d2d44; align-self:flex-start; }
#inputArea { display:flex; gap:5px; padding:10px; width:100%; background:rgba(0,0,0,0.3); }
#messageInput { flex:1; padding:10px; border-radius:15px; border:none; outline:none; }
button { padding:10px 15px; border:none; border-radius:12px; background:#6366f1; color:white; cursor:pointer; font-weight:500; }
#createRoomArea { display:flex; gap:5px; padding:10px; background:rgba(0,0,0,0.2); }
#createRoomArea input { padding:5px; border-radius:12px; border:none; outline:none; }
#deleteRoomBtn { background:#f87171; }
</style>
</head>
<body>

<header>Educational Chat</header>

<div id="usernameArea">
  <input id="usernameInput" placeholder="Enter your name..." />
  <button id="setUsernameBtn">Start Chat</button>
</div>

<div id="rooms" style="display:none;"></div>
<div id="chat" style="display:none;"></div>

<div id="createRoomArea" style="display:none;">
  <input id="newRoomName" placeholder="Room name" />
  <input id="newRoomPass" placeholder="Password (optional)" />
  <button id="createRoomBtn">Create Room</button>
  <button id="deleteRoomBtn">Delete Room</button>
</div>

<div id="inputArea" style="display:none;">
  <input id="messageInput" placeholder="Type a message..." />
  <button id="sendBtn">Send</button>
  <button id="clearBtn">Clear Chat</button>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

<script>
// --- Firebase config ---
const firebaseConfig = {
  apiKey: "AIzaSyD9GQMi0v4ItnkJ2uqKtUUQU59DorLrCAg",
  authDomain: "live-chat-3d2c3.firebaseapp.com",
  projectId: "live-chat-3d2c3",
  storageBucket: "live-chat-3d2c3.appspot.com",
  messagingSenderId: "550798266942",
  appId: "1:550798266942:web:2ce678f70e4f64d6f7376f"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
firebase.auth().signInAnonymously();

let username = "";
let currentRoom = "General";
let roomCreators = {};
let unsubscribeMessages = null;

// --- DOM elements ---
const chatDiv = document.getElementById("chat");
const roomsDiv = document.getElementById("rooms");
const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const clearBtn = document.getElementById("clearBtn");
const createRoomBtn = document.getElementById("createRoomBtn");
const deleteRoomBtn = document.getElementById("deleteRoomBtn");
const newRoomName = document.getElementById("newRoomName");
const newRoomPass = document.getElementById("newRoomPass");
const usernameInput = document.getElementById("usernameInput");
const setUsernameBtn = document.getElementById("setUsernameBtn");

// --- Set username ---
setUsernameBtn.onclick = ()=>{
  const name = usernameInput.value.trim();
  if(!name) return alert("Enter your name!");
  username = name;

  // show chat UI
  document.getElementById("usernameArea").style.display = "none";
  roomsDiv.style.display = "flex";
  chatDiv.style.display = "flex";
  document.getElementById("createRoomArea").style.display = "flex";
  document.getElementById("inputArea").style.display = "flex";

  ensureGeneral().then(loadRooms).then(()=>joinRoom("General"));
};

// --- Ensure General room exists ---
async function ensureGeneral(){
  const docRef = db.collection("rooms").doc("General");
  const docSnap = await docRef.get();
  if(!docSnap.exists) await docRef.set({name:"General", password:"", creator:"system"});
}

// --- Load rooms ---
function loadRooms(){
  db.collection("rooms").onSnapshot(snap=>{
    roomsDiv.innerHTML="";
    snap.forEach(d=>{
      const r = d.data();
      roomCreators[r.name] = r.creator;
      const div = document.createElement("div");
      div.className = "room " + (r.name===currentRoom?"selected":"");
      div.textContent = r.name;
      div.onclick = ()=> joinRoom(r.name,r.password);
      roomsDiv.appendChild(div);
    });
  });
}

// --- Join room ---
function joinRoom(name, pass=""){
  if(pass){
    const entered = prompt("Enter password for "+name);
    if(entered!==pass) return alert("Wrong password");
  }
  currentRoom = name;
  listenMessages();
  updateSelectedRoom();
}

// --- Highlight selected room ---
function updateSelectedRoom(){
  Array.from(roomsDiv.children).forEach(div=>{
    div.classList.toggle("selected", div.textContent===currentRoom);
  });
}

// --- Listen to messages ---
function listenMessages(){
  if(unsubscribeMessages) unsubscribeMessages();
  chatDiv.innerHTML="";
  unsubscribeMessages = db.collection("messages").where("room","==",currentRoom)
    .orderBy("createdAt")
    .onSnapshot(snap=>{
      chatDiv.innerHTML="";
      snap.forEach(docSnap=>{
        const m = docSnap.data();
        const div = document.createElement("div");
        div.className = "message "+(m.sender===username?"mine":"other");
        div.innerHTML = `<div class="sender">${m.sender}</div>${m.text}`;
        chatDiv.appendChild(div);
      });
      chatDiv.scrollTop = chatDiv.scrollHeight;
    });
}

// --- Send message ---
sendBtn.onclick = async ()=>{
  const text = messageInput.value.trim();
  if(!text) return;
  await db.collection("messages").add({
    text, sender:username, room:currentRoom, createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
  messageInput.value="";
};
messageInput.addEventListener("keypress", e=>{if(e.key==="Enter") sendBtn.onclick();});

// --- Clear chat ---
clearBtn.onclick = async ()=>{
  if(!confirm("Clear chat forever?")) return;
  const snap = await db.collection("messages").where("room","==",currentRoom).get();
  snap.forEach(d=>d.ref.delete());
};

// --- Create room ---
createRoomBtn.onclick = async ()=>{
  const name = newRoomName.value.trim();
  const pass = newRoomPass.value.trim();
  if(!name) return;
  await db.collection("rooms").doc(name).set({name,password:pass,creator:username});
  newRoomName.value=""; newRoomPass.value="";
  joinRoom(name,pass);
};

// --- Delete room ---
deleteRoomBtn.onclick = async ()=>{
  if(currentRoom==="General") return alert("Cannot delete General");
  if(roomCreators[currentRoom]!==username) return alert("Only the creator can delete this room");
  if(!confirm(`Delete room "${currentRoom}" and all its messages?`)) return;
  await db.collection("rooms").doc(currentRoom).delete();
  const snap = await db.collection("messages").where("room","==",currentRoom).get();
  snap.forEach(d=>d.ref.delete());
  joinRoom("General");
};
</script>

</body>
</html>