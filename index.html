<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, getDocs, query, where, setDoc } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInAnonymously } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

console.log("Chat app starting...");

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyD9GQMi0v4ItnkJ2uqKtUUQU59DorLrCAg",
  authDomain: "live-chat-3d2c3.firebaseapp.com",
  projectId: "live-chat-3d2c3",
  storageBucket: "live-chat-3d2c3.firebasestorage.app",
  messagingSenderId: "550798266942",
  appId: "1:550798266942:web:2ce678f70e4f64d6f7376f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let username = "";
let currentRoom = "General";
let unsubscribe = null;
let createdRooms = [];

// DOM
const chat = document.getElementById("chat");
const roomsDiv = document.getElementById("rooms");
const input = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const clearBtn = document.getElementById("clearBtn");
const createRoomBtn = document.getElementById("createRoomBtn");
const newRoomName = document.getElementById("newRoomName");

// AUTH FIRST
signInAnonymously(auth).then(userCred => {
  username = userCred.user.uid;
  console.log("Signed in:", username);
  startApp();
}).catch(err => {
  console.error("Auth error:", err);
});

function startApp() {
  ensureGeneral();
  loadRooms();
  joinRoom("General");
}

async function ensureGeneral() {
  await setDoc(doc(db,"rooms","General"), {
    name:"General"
  }, { merge:true });
}

function loadRooms() {
  onSnapshot(collection(db,"rooms"), snap=>{
    roomsDiv.innerHTML="";
    snap.forEach(d=>{
      const room = d.data().name;
      const div = document.createElement("div");
      div.className="room";
      if(room===currentRoom) div.classList.add("selected");
      div.textContent = room;
      div.onclick = ()=> joinRoom(room);
      roomsDiv.appendChild(div);
    });
  });
}

function joinRoom(name) {
  currentRoom = name;

  if(unsubscribe) unsubscribe();

  unsubscribe = onSnapshot(
    query(collection(db,"messages"), where("room","==",currentRoom)),
    snap=>{
      chat.innerHTML="";
      snap.forEach(docSnap=>{
        const m = docSnap.data();
        const div = document.createElement("div");
        div.className="message " + (m.sender===username?"mine":"other");
        div.innerHTML = `<div class="sender">${m.sender}</div>${m.text}`;
        chat.appendChild(div);
      });
      chat.scrollTop = chat.scrollHeight;
    }
  );
}

// SEND MESSAGE
sendBtn.onclick = async ()=>{
  const text = input.value.trim();
  if(!text) return;

  await addDoc(collection(db,"messages"),{
    text:text,
    sender:username,
    room:currentRoom
  });

  input.value="";
};

// CLEAR CHAT FOREVER
clearBtn.onclick = async ()=>{
  const snap = await getDocs(
    query(collection(db,"messages"), where("room","==",currentRoom))
  );

  for(const d of snap.docs){
    await deleteDoc(d.ref);
  }
};

// CREATE ROOM
createRoomBtn.onclick = async ()=>{
  const name = newRoomName.value.trim();
  if(!name) return;

  await setDoc(doc(db,"rooms",name),{name:name});
  createdRooms.push(name);
  newRoomName.value="";
  joinRoom(name);
};

// DELETE CREATED ROOMS WHEN TAB CLOSES
window.addEventListener("beforeunload", async ()=>{
  for(const room of createdRooms){
    const snap = await getDocs(
      query(collection(db,"messages"), where("room","==",room))
    );
    for(const d of snap.docs){
      await deleteDoc(d.ref);
    }
    await deleteDoc(doc(db,"rooms",room));
  }
});
</script>