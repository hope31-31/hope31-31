<script>
// ğŸ” Firebase
firebase.initializeApp({
  apiKey: "AIzaSyD9GQMi0v4ItnkJ2uqKtUUQU59DorLrCAg",
  authDomain: "live-chat-3d2c3.firebaseapp.com",
  projectId: "live-chat-3d2c3"
});
const db = firebase.firestore();
const serverTime = firebase.firestore.FieldValue.serverTimestamp();

// ğŸ‘¤ Username
let username = localStorage.getItem("username");
while (!username || username.trim().length < 2) {
  username = prompt("Enter a username (2+ letters)");
}
username = username.trim();
localStorage.setItem("username", username);

// ğŸŒ Elements
const roomsEl = document.getElementById("rooms");
const usersEl = document.getElementById("users");
const chatEl = document.getElementById("chat");
const typingEl = document.getElementById("typing");
const form = document.getElementById("form");
const msgInput = document.getElementById("msg");
const newRoomInput = document.getElementById("new-room");
const newRoomPass = document.getElementById("new-room-pass");
const createRoomBtn = document.getElementById("create-room");
const clearBtn = document.getElementById("clear-btn");
const inviteBtn = document.getElementById("invite-btn");
const changeInput = document.getElementById("change-username");
const changeBtn = document.getElementById("change-btn");

let currentRoom = "General";
let rooms = {};
let unsubscribe = null;

// --- ENSURE GENERAL ROOM EXISTS ---
db.collection("rooms").doc("General").get().then(d => {
  if (!d.exists) {
    db.collection("rooms").doc("General").set({ name: "General", password: "" });
  }
  loadRooms();
});

// --- LOAD ROOMS ---
function loadRooms() {
  db.collection("rooms").onSnapshot(snap => {
    roomsEl.innerHTML = "";
    rooms = {};
    snap.forEach(d => {
      const data = d.data();
      rooms[data.name] = data.password;
      const div = document.createElement("div");
      div.className = "room " + (data.name === currentRoom ? "selected" : "");
      div.textContent = data.name;
      div.onclick = () => joinRoom(data.name);
      roomsEl.appendChild(div);
    });
  });
}

// --- JOIN ROOM ---
function joinRoom(room) {
  const pass = rooms[room];
  if (pass && pass !== "") {
    const entered = prompt("Enter password for " + room);
    if (entered !== pass) return alert("Wrong password");
  }
  currentRoom = room;
  listenMessages();
}

// --- LISTEN MESSAGES ---
function listenMessages() {
  if (unsubscribe) unsubscribe();
  chatEl.innerHTML = "";
  unsubscribe = db.collection("messages")
    .where("room", "==", currentRoom)
    .orderBy("time")
    .onSnapshot(snapshot => {
      chatEl.innerHTML = "";
      snapshot.forEach(d => {
        const m = d.data();
        const div = document.createElement("div");
        div.className = "msg " + (m.user === username ? "me" : "other");
        div.innerHTML = `<div class="meta">${m.user}</div>${m.text}`;
        chatEl.appendChild(div);
      });
      chatEl.scrollTop = chatEl.scrollHeight;
    });
}
joinRoom("General");

// --- CREATE ROOM ---
createRoomBtn.onclick = () => {
  const r = newRoomInput.value.trim();
  if (!r) return;
  db.collection("rooms").doc(r).set({
    name: r,
    password: newRoomPass.value.trim()
  });
  newRoomInput.value = "";
  newRoomPass.value = "";
};

// --- SEND MESSAGE ---
form.onsubmit = e => {
  e.preventDefault();
  const text = msgInput.value.trim();
  if (!text) return;
  db.collection("messages").add({
    user: username,
    text,
    room: currentRoom,
    time: serverTime
  });
  msgInput.value = "";
};

// --- ONLINE USERS ---
const onlineRef = db.collection("online").doc(username);
onlineRef.set({ name: username });

window.addEventListener("beforeunload", () => {
  navigator.sendBeacon && navigator.sendBeacon("/", "");
  onlineRef.delete();
});

db.collection("online").onSnapshot(s => {
  usersEl.innerHTML = "";
  s.forEach(d => {
    const u = d.data().name;
    const div = document.createElement("div");
    div.className = "user";
    div.innerHTML = `<div class="avatar">${u[0].toUpperCase()}</div>${u}`;
    usersEl.appendChild(div);
  });
});

// --- TYPING ---
msgInput.oninput = () => {
  db.collection("typing").doc(username).set({ room: currentRoom });
  setTimeout(() => db.collection("typing").doc(username).delete(), 700);
};

db.collection("typing").onSnapshot(s => {
  const typingUsers = s.docs
    .map(d => d.id)
    .filter(u => u !== username);
  typingEl.textContent = typingUsers.length ? "Someone is typingâ€¦" : "";
});

// --- CLEAR CHAT (REAL) ---
clearBtn.onclick = async () => {
  const snap = await db.collection("messages").where("room", "==", currentRoom).get();
  snap.forEach(d => d.ref.delete());
};

// --- INVITE ---
inviteBtn.onclick = () => {
  navigator.clipboard.writeText(location.href);
  alert("Invite link copied!");
};

// --- CHANGE USERNAME ---
changeBtn.onclick = () => {
  const newName = changeInput.value.trim();
  if (newName.length < 2) return alert("Enter 2+ letters");
  onlineRef.delete();
  localStorage.setItem("username", newName);
  location.reload();
};
</script>