<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Class Chat Live v2</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  html, body { margin:0; padding:0; height:100%; font-family:"Georgia",sans-serif; background:#1e1b2d; color:#dcd6f7; display:flex; flex-direction:column; }
  header { padding:10px 15px; background:#4b3b77; display:flex; justify-content:space-between; align-items:center; font-size:1rem; }
  header span { opacity:0.85; }
  #username { background:#2b2244; border:1px solid #6658a8; color:#e0d9ff; padding:5px 8px; border-radius:4px; width:120px; font-size:0.9rem; }
  #roomSelect { background:#2b2244; border:1px solid #6658a8; color:#e0d9ff; padding:5px 8px; border-radius:4px; margin-left:10px; font-size:0.9rem; }
  #chat { flex:1; overflow-y:auto; padding:10px 12px; scrollbar-width: thin; scrollbar-color:#7fa1ff #2b2244; }
  #chat::-webkit-scrollbar { width:6px; }
  #chat::-webkit-scrollbar-thumb { background-color:#7fa1ff; border-radius:4px; }
  .msg { margin-bottom:8px; padding:6px 10px; border-radius:6px; background:#3a2e66; max-width:80%; word-wrap:break-word; color:#e0d9ff; }
  .me { background:#5a7fff; margin-left:auto; text-align:right; color:#fff; }
  .meta { font-size:0.7rem; opacity:0.7; margin-bottom:1px; }
  .text { font-size:0.95rem; }
  .imgMsg { max-width:150px; border-radius:6px; display:block; margin-top:4px; }
  #form { display:flex; padding:8px 12px; background:#4b3b77; gap:6px; }
  #message { flex:1; padding:8px; border-radius:4px; border:1px solid #6658a8; background:#2b2244; color:#e0d9ff; font-size:0.95rem; }
  #send, #clear, #upload, #voiceBtn { padding:8px 12px; border:none; border-radius:4px; background:#7fa1ff; color:#111b33; font-weight:bold; cursor:pointer; font-size:0.95rem; }
  #send:disabled { opacity:0.5; cursor:default; }
  #sidebar { width:150px; background:#3b335a; padding:6px; display:flex; flex-direction:column; font-size:0.8rem; overflow-y:auto; }
  #usersOnline { margin-top:6px; }
  #container { flex:1; display:flex; }
  #main { flex:1; display:flex; flex-direction:column; }
</style>
</head>
<body>

<header>
  <div>
    <span>Name:</span> <input id="username" placeholder="you">
    <select id="roomSelect">
      <option value="general">General Room</option>
    </select>
  </div>
  <div>
    <button id="voiceBtn">ðŸŽ¤ Unmuted</button>
    <button id="clear">Clear</button>
    <input type="file" id="upload" accept="image/*">
  </div>
</header>

<div id="container">
  <div id="main">
    <div id="chat"></div>
    <form id="form">
      <input id="message" autocomplete="off" placeholder="Type a message...">
      <button id="send" type="submit">Send</button>
    </form>
  </div>
  <div id="sidebar">
    <strong>Online Users:</strong>
    <div id="usersOnline"></div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
  // ðŸ”¥ Your Firebase config ðŸ”¥
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  const chatEl = document.getElementById("chat");
  const formEl = document.getElementById("form");
  const msgInput = document.getElementById("message");
  const userInput = document.getElementById("username");
  const sendBtn = document.getElementById("send");
  const clearBtn = document.getElementById("clear");
  const uploadInput = document.getElementById("upload");
  const roomSelect = document.getElementById("roomSelect");
  const voiceBtn = document.getElementById("voiceBtn");
  const usersOnlineEl = document.getElementById("usersOnline");

  let username = "";
  let currentRoom = "general";
  let muted = false;

  // --- USER ONLINE MANAGEMENT ---
  const onlineUsersRef = db.collection("onlineUsers");
  function updateOnlineUsers(){
    onlineUsersRef.where("room","==",currentRoom).onSnapshot(snapshot=>{
      usersOnlineEl.innerHTML = "";
      snapshot.forEach(doc=>{
        const u = doc.data();
        const div = document.createElement("div");
        div.textContent = u.name;
        usersOnlineEl.appendChild(div);
      });
    });
  }

  // --- CHAT FUNCTIONS ---
  function addMessage(msg, isMe){
    const wrap = document.createElement("div");
    wrap.className = "msg" + (isMe ? " me" : "");
    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = msg.name + " â€¢ " + new Date(msg.time).toLocaleTimeString();
    wrap.appendChild(meta);

    const textDiv = document.createElement("div");
    textDiv.className = "text";
    textDiv.textContent = msg.text || "";
    wrap.appendChild(textDiv);

    if(msg.imgUrl){
      const img = document.createElement("img");
      img.src = msg.imgUrl;
      img.className = "imgMsg";
      wrap.appendChild(img);
    }

    chatEl.appendChild(wrap);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function clearChatLocal(){ chatEl.innerHTML=""; }

  formEl.addEventListener("submit", e=>{
    e.preventDefault();
    const text = msgInput.value.trim();
    if(!text) return;
    const msg = {name:username||"anon", text, time:Date.now(), room:currentRoom};
    db.collection("messages").add(msg);
    msgInput.value="";
  });

  clearBtn.addEventListener("click", clearChatLocal);

  uploadInput.addEventListener("change", e=>{
    const file = e.target.files[0];
    if(!file) return;
    const storageRef = storage.ref(`images/${Date.now()}_${file.name}`);
    storageRef.put(file).then(snapshot=>{
      snapshot.ref.getDownloadURL().then(url=>{
        const msg = {name:username||"anon", imgUrl:url, time:Date.now(), room:currentRoom};
        db.collection("messages").add(msg);
      });
    });
  });

  // --- ROOM MANAGEMENT ---
  roomSelect.addEventListener("change", e=>{
    currentRoom = e.target.value;
    chatEl.innerHTML="";
    listenMessages();
    updateOnlineUsers();
  });

  function listenMessages(){
    db.collection("messages")
      .where("room","==",currentRoom)
      .orderBy("time")
      .onSnapshot(snapshot=>{
        chatEl.innerHTML="";
        snapshot.forEach(doc=>{
          const msg = doc.data();
          addMessage(msg,msg.name===username);
        });
      });
  }

  // --- VOICE CHAT ---
  let localStream;
  let peers = {};
  async function startVoice(){
    if(muted){ muted=false; voiceBtn.textContent="ðŸŽ¤ Unmuted"; }
    else{ muted=true; voiceBtn.textContent="ðŸŽ¤ Muted"; }
  }
  voiceBtn.addEventListener("click", startVoice);

  // --- USER LOGIN ---
  userInput.addEventListener("blur", e=>{
    username = userInput.value.trim()||"anon";
    onlineUsersRef.doc(username).set({name:username, room:currentRoom});
    updateOnlineUsers();
    listenMessages();
  });

</script>
</body>
</html>