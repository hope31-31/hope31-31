<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Final Class Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
/* --- COLORS & FONTS --- */
:root {
  --primary-bg: #f0f4f8;
  --sidebar-bg: #d6e0f0;
  --chat-bg: #ffffff;
  --my-msg-bg: #a2c4f1;
  --other-msg-bg: #e0eaf6;
  --text-color: #1b1b1b;
  --meta-color: #555;
  --accent: #7ea7e0;
}

* { box-sizing: border-box; margin:0; padding:0; font-family: "Arial", sans-serif; }

body { 
  height: 100vh; display: flex; flex-direction: row; background: var(--primary-bg); color: var(--text-color);
}

/* --- SIDEBAR --- */
#sidebar {
  width: 250px;
  background: var(--sidebar-bg);
  display:flex; flex-direction:column; padding:12px;
  overflow-y:auto;
}
#sidebar h2 { margin-bottom:10px; font-size:1.2rem; }
#rooms, #online-users { margin-bottom:16px; }
.room, .user { padding:6px 8px; border-radius:6px; margin-bottom:6px; cursor:pointer; background:#cfe0f5; display:flex; align-items:center; justify-content:space-between; }
.room.selected, .user.selected { background:var(--accent); color:#fff; }
.room:hover, .user:hover { background:#b0c9eb; }

.avatar-small { width:30px; height:30px; border-radius:50%; margin-right:6px; object-fit:cover; }

/* --- CHAT AREA --- */
#chat-container { flex:1; display:flex; flex-direction:column; background: var(--chat-bg); }
#chat { flex:1; overflow-y:auto; padding:12px; display:flex; flex-direction:column; gap:6px; }

.msg { max-width:75%; padding:8px 12px; border-radius:12px; position:relative; word-wrap:break-word; }
.me { background: var(--my-msg-bg); align-self:flex-end; color:#000; }
.other { background: var(--other-msg-bg); align-self:flex-start; color:#000; }

.meta { font-size:0.7rem; color:var(--meta-color); margin-bottom:2px; }
.typing { font-size:0.7rem; font-style:italic; color:#888; margin-left:4px; }

/* --- INPUT AREA --- */
#form { display:flex; padding:10px; background:var(--sidebar-bg); gap:6px; }
#message { flex:1; padding:10px; border-radius:8px; border:1px solid #aaa; font-size:1rem; }
#send, #clear { padding:10px 14px; border:none; border-radius:8px; background:var(--accent); color:#fff; cursor:pointer; font-weight:bold; }
#send:disabled, #clear:disabled { opacity:0.5; cursor:default; }

/* --- RESPONSIVE --- */
@media (max-width:768px) {
  #sidebar { width:180px; font-size:0.9rem; padding:8px; }
  .avatar-small { width:24px; height:24px; }
  #message { font-size:0.9rem; }
  #send, #clear { padding:8px 12px; font-size:0.9rem; }
}
</style>
</head>
<body>

<!-- --- SIDEBAR --- -->
<div id="sidebar">
  <h2>Rooms</h2>
  <div id="rooms">
    <div class="room selected" data-room="General">General</div>
  </div>
  <input id="new-room-name" placeholder="New room name" style="padding:6px; border-radius:6px; border:1px solid #aaa; margin-bottom:6px;">
  <button id="create-room" style="padding:6px; border-radius:6px; border:none; background:var(--accent); color:#fff; cursor:pointer;">Create Room</button>
  
  <h2>Online Users</h2>
  <div id="online-users"></div>
</div>

<!-- --- CHAT AREA --- -->
<div id="chat-container">
  <div id="chat"></div>
  <form id="form">
    <input id="message" autocomplete="off" placeholder="Type a message...">
    <button id="send" type="submit">Send</button>
    <button type="button" id="clear">Clear</button>
  </form>
</div>

<!-- --- FIREBASE --- -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
  // --- CONFIG ---
  const firebaseConfig = {
    apiKey: "AIzaSyD9GQMi0v4ItnkJ2uqKtUUQU59DorLrCAg",
    authDomain: "live-chat-3d2c3.firebaseapp.com",
    projectId: "live-chat-3d2c3",
    storageBucket: "live-chat-3d2c3.firebasestorage.app",
    messagingSenderId: "550798266942",
    appId: "1:550798266942:web:2ce678f70e4f64d6f7376f",
    measurementId: "G-L0K72L8894"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // --- STATE ---
  let username = localStorage.getItem("username") || "User";
  let currentRoom = "General";
  let typingTimeout;

  const chatEl = document.getElementById("chat");
  const formEl = document.getElementById("form");
  const msgInput = document.getElementById("message");
  const sendBtn = document.getElementById("send");
  const clearBtn = document.getElementById("clear");
  const onlineUsersEl = document.getElementById("online-users");
  const roomsEl = document.getElementById("rooms");
  const newRoomInput = document.getElementById("new-room-name");
  const createRoomBtn = document.getElementById("create-room");

  // --- FUNCTIONS ---
  function addMessage(msg) {
    const div = document.createElement("div");
    div.className = msg.sender === username ? "msg me" : "msg other";

    const meta = document.createElement("div");
    meta.className="meta";
    meta.textContent = msg.sender;

    const text = document.createElement("div");
    text.textContent = msg.text;

    const typing = document.createElement("div");
    typing.className="typing";
    typing.textContent = msg.typing ? "â€¦" : "";

    div.appendChild(meta);
    div.appendChild(text);
    div.appendChild(typing);
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function updateOnlineUsers(users) {
    onlineUsersEl.innerHTML="";
    users.forEach(u=>{
      const div = document.createElement("div");
      div.className="user";
      div.textContent=u;
      onlineUsersEl.appendChild(div);
    });
  }

  function joinRoom(room) {
    currentRoom = room;
    document.querySelectorAll(".room").forEach(r=>r.classList.remove("selected"));
    document.querySelector(`[data-room="${room}"]`).classList.add("selected");
    listenMessages(room);
  }

  function listenMessages(room) {
    chatEl.innerHTML="";
    db.collection("messages").where("room","==",room).orderBy("time")
      .onSnapshot(snapshot=>{
        chatEl.innerHTML="";
        snapshot.forEach(doc=>{
          addMessage(doc.data());
        });
      });
  }

  // --- SEND MESSAGE ---
  formEl.addEventListener("submit", e=>{
    e.preventDefault();
    if(!msgInput.value.trim()) return;
    db.collection("messages").add({
      text: msgInput.value,
      sender: username,
      room: currentRoom,
      time: Date.now(),
      typing:false
    });
    msgInput.value="";
  });

  // --- CLEAR ---
  clearBtn.addEventListener("click", ()=>{
    chatEl.innerHTML="";
  });

  // --- CREATE ROOM ---
  createRoomBtn.addEventListener("click", ()=>{
    const roomName = newRoomInput.value.trim();
    if(!roomName) return;
    const div = document.createElement("div");
    div.className="room";
    div.textContent=roomName;
    div.dataset.room=roomName;
    div.addEventListener("click", ()=>joinRoom(roomName));
    roomsEl.appendChild(div);
    newRoomInput.value="";
  });

  // --- ONLINE USERS ---
  const onlineRef = db.collection("online");
  function setOnline() {
    onlineRef.doc(username).set({online:true});
  }
  setOnline();
  window.addEventListener("beforeunload", ()=>onlineRef.doc(username).delete());

  onlineRef.onSnapshot(snapshot=>{
    const users = snapshot.docs.map(d=>d.id);
    updateOnlineUsers(users);
  });

  // --- INITIAL ---
  joinRoom(currentRoom);

</script>
</body>
</html>